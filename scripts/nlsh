#!/bin/bash
export TTY

sn="$(basename "$0")"

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    "") { shift; }; ;;
    -norl) {
        norl=y
        shift
    }
    ;;

    *) break;
esac; done

if ! test "$norl" = "y"; then
    rlwrap "$sn" -norl "$@"
    exit $?
fi

# pf-code-snippet-from-natural-language/2
# pf-nlsh/2

case "$sn" in
    nlsh) { prompt=pf-nlsh/2; } ;;
    nlsc) { prompt=pf-code-snippet-from-natural-language/2; } ;;

    *)
esac

os_or_lang="$1"
shift

test -n "$os_or_lang" || {
    echo "Requires 1 argument: OS or lang" 1>&2
    exit 2
}

export USE_CONVERSATION_MODE=y

# rlwrap openai-complete.sh prompts/nlsh-2.prompt "$os_or_lang"

while IFS=$'\n' read -p "${os_or_lang}: " -r nlcommand; do
    if test "$nlcommand" = "!!"; then
        nlcommand="$lastcmd"
        do_update=y
    else
        do_update=
    fi

    (
        test "do_update" = y && export UPDATE=y
        pena "$prompt" "${os_or_lang}" "$nlcommand" | jq -r ".[]"
    )

    lastcmd="$nlcommand"
    # pena -u "$prompt" "${os_or_lang}" "$nlcommand" | jq -r ". | map(. + \"\\n\\n\")"
done
