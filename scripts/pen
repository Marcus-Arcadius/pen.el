#!/bin/bash

{
stty stop undef; stty start undef
} 2>/dev/null

# TODO Add ability to share a file or entire directory with the host -- this would only work for docker run though
# But file sharing could work with the client if I use a hardlink to the ~/.pen/documents directory
# docker run --rm -v "$(pwd):/$(pwd | slugify)" -w "/$(pwd | slugify)" -ti --entrypoint= semiosis/pen.el:latest ./run.sh

IFS= read -r -d '' banner <<HEREDOC
 [0;1;31;91mâ–„[0;1;33;93mâ–„â–„[0;1;32;92mâ–„â–„[0;1;36;96mâ–„[0m                                            [0;1;33;93mâ–„[0;1;32;92mâ–„â–„[0;1;36;96mâ–„[0m
 [0;1;33;93mâ–ˆ[0;1;32;92mâ–ˆâ–€[0;1;36;96mâ–€â–€[0;1;34;94mâ–€â–ˆ[0;1;35;95mâ–„[0m                                          [0;1;32;92mâ–€[0;1;36;96mâ–€â–ˆ[0;1;34;94mâ–ˆ[0m
 [0;1;32;92mâ–ˆ[0;1;36;96mâ–ˆ[0m    [0;1;35;95mâ–ˆ[0;1;31;91mâ–ˆ[0m   [0;1;32;92mâ–„â–ˆ[0;1;36;96mâ–ˆâ–ˆ[0;1;34;94mâ–ˆâ–„[0m   [0;1;31;91mâ–ˆ[0;1;33;93mâ–ˆâ–„[0;1;32;92mâ–ˆâ–ˆ[0;1;36;96mâ–ˆâ–ˆ[0;1;34;94mâ–„[0m             [0;1;35;95mâ–„â–ˆ[0;1;31;91mâ–ˆâ–ˆ[0;1;33;93mâ–ˆâ–„[0m     [0;1;34;94mâ–ˆ[0;1;35;95mâ–ˆ[0m
 [0;1;36;96mâ–ˆ[0;1;34;94mâ–ˆâ–ˆ[0;1;35;95mâ–ˆâ–ˆ[0;1;31;91mâ–ˆâ–€[0m   [0;1;32;92mâ–ˆ[0;1;36;96mâ–ˆâ–„[0;1;34;94mâ–„â–„[0;1;35;95mâ–„â–ˆ[0;1;31;91mâ–ˆ[0m  [0;1;33;93mâ–ˆ[0;1;32;92mâ–ˆâ–€[0m   [0;1;34;94mâ–ˆ[0;1;35;95mâ–ˆ[0m            [0;1;35;95mâ–ˆ[0;1;31;91mâ–ˆâ–„[0;1;33;93mâ–„â–„[0;1;32;92mâ–„â–ˆ[0;1;36;96mâ–ˆ[0m    [0;1;35;95mâ–ˆ[0;1;31;91mâ–ˆ[0m
 [0;1;34;94mâ–ˆ[0;1;35;95mâ–ˆ[0m        [0;1;36;96mâ–ˆ[0;1;34;94mâ–ˆâ–€[0;1;35;95mâ–€â–€[0;1;31;91mâ–€â–€[0;1;33;93mâ–€[0m  [0;1;32;92mâ–ˆ[0;1;36;96mâ–ˆ[0m    [0;1;35;95mâ–ˆ[0;1;31;91mâ–ˆ[0m            [0;1;31;91mâ–ˆ[0;1;33;93mâ–ˆâ–€[0;1;32;92mâ–€â–€[0;1;36;96mâ–€â–€[0;1;34;94mâ–€[0m    [0;1;31;91mâ–ˆ[0;1;33;93mâ–ˆ[0m
 [0;1;35;95mâ–ˆ[0;1;31;91mâ–ˆ[0m        [0;1;34;94mâ–€[0;1;35;95mâ–ˆâ–ˆ[0;1;31;91mâ–„â–„[0;1;33;93mâ–„â–„[0;1;32;92mâ–ˆ[0m  [0;1;36;96mâ–ˆ[0;1;34;94mâ–ˆ[0m    [0;1;31;91mâ–ˆ[0;1;33;93mâ–ˆ[0m     [0;1;34;94mâ–ˆâ–ˆ[0m     [0;1;33;93mâ–€[0;1;32;92mâ–ˆâ–ˆ[0;1;36;96mâ–„â–„[0;1;34;94mâ–„â–„[0;1;35;95mâ–ˆ[0m    [0;1;33;93mâ–ˆ[0;1;32;92mâ–ˆâ–„[0;1;36;96mâ–„â–„[0m
 [0;1;31;91mâ–€[0;1;33;93mâ–€[0m          [0;1;31;91mâ–€[0;1;33;93mâ–€â–€[0;1;32;92mâ–€â–€[0m   [0;1;34;94mâ–€[0;1;35;95mâ–€[0m    [0;1;33;93mâ–€[0;1;32;92mâ–€[0m     [0;1;35;95mâ–€â–€[0m       [0;1;36;96mâ–€[0;1;34;94mâ–€â–€[0;1;35;95mâ–€â–€[0m      [0;1;36;96mâ–€â–€[0;1;34;94mâ–€â–€[0m

              [0;1;35;95mPr[0;1;31;91mom[0;1;33;93mpt[0m [0;1;32;92mE[0;1;36;96mng[0;1;34;94min[0;1;35;95mee[0;1;31;91mri[0;1;33;93mng[0m [0;1;32;92mi[0;1;36;96mn[0m [0;1;34;94mEm[0;1;35;95mac[0;1;31;91ms[0m
HEREDOC

IFS= read -r -d '' info_txt <<HEREDOC
Pen is under continual development.
If something is broken, try pulling everything.
If it's still broken, try again in a day.
If it's still broken, please make an issue on GitHub.
https://github.com/semiosis/pen.el/
HEREDOC

is_tty() { [ -t 1 ]; }

if is_tty; then
    HAS_TTY=y
else
    HAS_TTY=n
    batch=y
fi

sn="$(basename "$0")"
bn="$(basename "$0")"
rp="$(realpath "$0")"

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    "") { shift; }; ;;
    -tty|-nw) {
        use_tty=y
        shift
    }
    ;;

    -d) {
        DEBUG=y
        shift
    }
    ;;

    -u) {
        UPDATE=y
        shift
    }
    ;;

    -Q) {
        vanilla=y
        use_pen_config=n
        shift
    }
    ;;

    -q) {
        vanilla=y
        use_pen_config=y
        shift
    }
    ;;

    *) break;
esac; done

cmd() {
    for var in "$@"
    do
        printf "'%s' " "$(printf %s "$var" | sed "s/'/'\\\\''/g")";
    done | sed 's/ $//'
}

cmd-nice() {
    for var in "$@"
    do
        printf '"%s" ' "$(printf %s "$var" | sed 's/"/\\"/g')";
    done | sed 's/ $//'
}

vanilla=
use_pen_config=y

if test -d "$PEN_CONFIG_DIR"; then
    mkdir -p "$PEN_CONFIG_DIR/documents"
fi

if test "$use_pen_config" = "y"; then
    if ! test "$batch" = "y"; then
        if ! test -d "$HOME/.pen" && yn "Create ~/.pen on host (store API keys and generations)?"; then
            mkdir -p "$HOME/.pen"
        fi
    fi

    test -d "$HOME/.pen" && : "${PEN_CONFIG_DIR:="$HOME/.pen"}"

    if ! test "$batch" = "y"; then
        : "${PEN_CONFIG_DIR:="$(read -ep "PEN_CONFIG_DIR (leave empty to use docker): ")"}"
    fi

    if test -d "$PEN_CONFIG_DIR"; then
        PEN_CONFIG_DIR="$(realpath "$PEN_CONFIG_DIR")"
    fi
fi

if test "$sn" = pen && \
    test "$#" -eq 1 && \
    test -n "$1" && \
    test -f "$1" && \
    test -d "$PEN_CONFIG_DIR/documents"; then

    rp="$(realpath "$1")"
    bn="$(basename "$rp")"
    ln -f "$rp" "$PEN_CONFIG_DIR/documents/$bn"
    shift

    sn=penc

    # set -- -e "(find-file $(cmd-nice "/root/.pen/documents/$bn")"

    set -- "/root/.pen/documents/$bn"
fi

if test "$sn" = pen && test "$1" = -e; then
    shift
    sn=pene
fi

if test "$sn" = pen && test "$#" -eq 0 && test -n "$(docker ps --filter "name=pen" | sed 1d)"; then
    sn=penc
fi

stdin_exists() {
    ! [ -t 0 ] && ! test "$(readlink /proc/$$/fd/0)" = /dev/null
}

if test "$sn" = pena; then
    sn=penf
    all=y
fi

case "$sn" in
    penf) {
        if test "$#" -eq 0; then
            sn=penl
            penl_strip_pf=y
        elif test "$#" -eq 1; then
            sn=penh
            penl_strip_pf=y
        fi
    }
    ;;

    *)
esac

case "$sn" in
    pen|penf) {
        while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
            "") { shift; }; ;;
            -all) {
                all=y
                shift
            }
            ;;

            *) break;
        esac; done

        if test "$sn" = penf; then
            if test -n "$1" && ! printf -- "%s\n" "$1" | grep -q -P '^pf-'; then
                fun="pf-$1"
                shift
            else
                fun="$1"
                shift
            fi
            sn="pen"
        else
            fun="$1"
            shift
        fi

        if printf -- "%s\n" "$fun" | grep -q -P '^pf-'; then
            show_banner=n

            pfname="$fun"

            use_tty=y

            if stdin_exists; then
                set -- "$(cat)" "$@"
            fi

            CMD="$(cmd-nice "$@")"

            if test "$all" = "y"; then
                if test "$UPDATE" = y; then
                    set -- -e "(pen-list2str (pen-update ($pfname $CMD :no-select-result t)))"
                else
                    set -- -e "(pen-list2str ($pfname $CMD :no-select-result t))"
                fi
            else
                if test "$UPDATE" = y; then
                    set -- -e "(pen-list2str (pen-single-generation (pen-update ($pfname $CMD :no-select-result t))))"
                else
                    set -- -e "(pen-list2str (pen-single-generation ($pfname $CMD :no-select-result t)))"
                fi
            fi

            HAS_TTY=n
            batch=y
            docker_cmd=exec
            remote_cmd=./.emacs.d/pen.el/scripts/eval.sh
        fi
    }
    ;;

    pensh) {
        # HAS_TTY=y
        batch=y
        use_tty=y
        docker_cmd=exec

        firstarg="$1"
        shift

        remote_cmd="$firstarg"
    }
    ;;

    penc) {
        set -- -c "$@"
    }
    ;;

    penw) {
        if test -d "$HOME/butterfly"; then
            cd "$HOME/butterfly"
            butterfly.server.py --host=localhost --port=57575 --unsecure --shell=pen
        else
            echo Could not find butterfly
        fi
        exit "$?"
    }
    ;;

    pene) {
        show_banner=n
        set -- -e "$@"
    }
    ;;

    penu) {
        show_banner=n
        UPDATE=y
        set -- -e "$@"
    }
    ;;

    penl) {
        show_banner=n
        set -- -e '(pen-list2str pen-prompt-functions)'
    }
    ;;

    penh) {
        if test -n "$1" && ! printf -- "%s\n" "$1" | grep -q -P '^pf-'; then
            fun="$1"
            shift

            set -- "pf-$fun" "$@"
        fi

        show_banner=n
        if test "$#" -eq 0; then
            fun="$(penz)"
        else
            fun="$1"
        fi
        set -- -e "(helpful--signature '$fun)"
    }
    ;;

    penq) {
        show_banner=n
        set -- -e "(kill-emacs)"
    }
    ;;

    penz) {
        show_banner=n
        fuzzy=y
        set -- -e '(pen-list2str pen-prompt-functions)'
    }
    ;;

    *) {
        show_banner=n
        if stdin_exists; then
            set -- "$(cat)" "$@"
        fi

        CMD="$(cmd-nice "$@")"
        set -- -e "(pen-list2str (pen-single-generation ($sn $CMD :no-select-result t)))"
        HAS_TTY=n
        batch=y
        docker_cmd=exec
        remote_cmd=./.emacs.d/pen.el/scripts/eval.sh
    }
    ;;
esac

{
if ! test "$show_banner" = n; then
    printf -- "%s\n" "$banner"
    echo
    echo Version 0.1

    printf -- "%s\n" "$info_txt"
    echo
fi
} 1>&2

: "${docker_cmd:="run"}"
: "${remote_cmd:="./run.sh"}"

opt="$1"
case "$opt" in
    uninstall) {
        set -xv
        sudo rm -irf ~/.pen
    }
    ;;

    *)
esac

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    "") { shift; }; ;;
    -c) {
        batch=y
        docker_cmd=exec

        shift

        CMD="$(cmd-nice "$@")"
        : ${CMD:="$(cmd-nice "$@")"}

        remote_cmd="./.emacs.d/pen.el/scripts/newframe.sh"

        # Shift all so it doesn't do -e here
        # shift "$#"
    }
    ;;

    -e) {
        HAS_TTY=n
        batch=y
        docker_cmd=exec
        remote_cmd=./.emacs.d/pen.el/scripts/eval.sh
        shift

        if test "$UPDATE" = "y"; then
            last_arg="${@: -1}"
            test "$#" -gt 0 && set -- "${@:1:$(($#-1))}" # shift last arg

            set -- "$@" "(pen-update $last_arg)"
        fi
    }
    ;;

    *) break;
esac; done

yn () {
    y_chars="Yy"
    n_chars="Nn"
    while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
        -N|-carefully) {
            allowed_re="^[YN]$"
            shift
        }
        ;;

        -y|-y-chars) {
            y_chars="$2"
            shift
            shift
        }
        ;;

        -n|-n-chars) {
            n_chars="$2"
            shift
            shift
        }
        ;;

        *) break;
    esac; done

    allowed_re="^[${y_chars}/${n_chars}]$"

    message="$@"

    : ${message:="Are you sure?"}

    exec 1>&2

    echo
    message="$(printf -- "%s" "$message")"
    echo -e " $message"
    echo

    allowed_re="$(printf -- "%s" "$allowed_re")"
    allowed_re_color="$(printf -- "%s" "$allowed_re")"

    if test "$YN_DEFAULT" = "y"; then
        echo y
        exit 0
    fi

    if test "$YN_DEFAULT" = "n"; then
        echo n
        exit 1
    fi

    while :; do
        read -p " $allowed_re_color: " -n 1 -r
        echo
        [[ $REPLY =~ $allowed_re ]] && break
    done
    echo

    [[ $REPLY =~ ^[$y_chars]$ ]]
}

if ! test "$vanilla" = "y"; then
    test -n "$MYGIT" && test -d "$MYGIT/semiosis/glossaries" && : "${GLOSSARIES_DIR:="$MYGIT/semiosis/glossaries"}"
    test -d "glossaries" && : "${GLOSSARIES_DIR:="glossaries"}"

    test -n "$MYGIT" && test -d "$MYGIT/semiosis/prompts" && : "${PROMPTS_DIR:="$MYGIT/semiosis/prompts"}"
    test -d "prompts" && : "${PROMPTS_DIR:="prompts"}"
    # : "${PROMPTS_DIR:="$(read -ep "PROMPTS_DIR (leave empty to use docker): ")"}"

    test -n "$MYGIT" && test -d "$MYGIT/semiosis/pen.el" && : "${PENEL_DIR:="$MYGIT/semiosis/pen.el"}"
    test -d "pen.el" && : "${PENEL_DIR:="pen.el"}"
    # : "${PENEL_DIR:="$(read -ep "PENEL_DIR (leave empty to use docker): ")"}"

    test -d "$MYGIT/semiosis/openai-api.el" && : "${OPENAI_API_EL_DIR:="$MYGIT/semiosis/openai-api.el"}"
    test -d "openai-api.el" && : "${OPENAI_API_EL_DIR:="openai-api.el"}"
    # : "${OPENAI_API_EL_DIR:="$(read -ep "OPENAI_API_EL_DIR (leave empty to use docker): ")"}"

    # yn "Pull docker image?" && docker pull semiosis/pen.el:latest

    # set -v
    if ! test "$batch" = "y"; then
        yn "Pull docker image?" && (
            echo docker pull semiosis/pen.el:latest
            docker pull semiosis/pen.el:latest
        )
    fi

    if ! test "$batch" = "y"; then
        if test -d "$PROMPTS_DIR"; then
            yn "Pull prompts repo? (recommended)" && (
                cd "$PROMPTS_DIR"
                git pull origin master
            )
        else
            yn "Clone prompts repo here?" && (
                git clone "http://github.com/semiosis/prompts"
            )
        fi
    fi

    test -d "prompts" && : "${PROMPTS_DIR:="prompts"}"

    if ! test "$batch" = "y"; then
        test -d "$PENEL_DIR" && yn "Pull pen.el repo? (recommended)" && (
            cd "$PENEL_DIR"
            git pull origin master
        )
    fi

    if test -d "$PROMPTS_DIR"; then
        PROMPTS_DIR="$(realpath "$PROMPTS_DIR")"
    fi

fi

case "$docker_cmd" in
    run) {
IFS= read -r -d '' shcode <<HEREDOC
    # --user "$(id -u):$(id -g)"
    docker "$docker_cmd" \
        $(test -n "$OPENAI_API_KEY" && printf -- "%s " -e "OPENAI_API_KEY:$OPENAI_API_KEY" ) \
        $(test -n "$PEN_CONFIG_DIR" && printf -- "%s " -v "$PEN_CONFIG_DIR:/root/.pen" ) \
        $(test -n "$PROMPTS_DIR" && printf -- "%s " -v "$PROMPTS_DIR:/root/.emacs.d/host/prompts" ) \
        $(test -n "$PENEL_DIR" && printf -- "%s " -v "$PENEL_DIR:/root/.emacs.d/host/pen.el" ) \
        $(test -n "$GLOSSARIES_DIR" && printf -- "%s " -v "$GLOSSARIES_DIR:/root/.emacs.d/host/glossaries" ) \
        $(test -n "$OPENAI_API_EL_DIR" && printf -- "%s " -v "$OPENAI_API_EL_DIR:/root/.emacs.d/host/openai-api.el" ) \
        $(test "$HAS_TTY" = y && printf -- "%s " -ti ) \
        --entrypoint= --name=pen semiosis/pen.el:latest "$remote_cmd" "$@"
HEREDOC
    }
    ;;

    # --user "$(id -u):$(id -g)"
    exec) {
        evalcommand="$(cmd "$(cmd eval "$(cmd "$remote_cmd" "$@")")")"
IFS= read -r -d '' shcode <<HEREDOC
docker "$docker_cmd" $(test "$HAS_TTY" = y && printf -- "%s " -ti ) pen bash -c $evalcommand
HEREDOC
    }
    ;;

    *)
esac

pen_eval() {
    if test "$DEBUG" = "y"; then
        firstarg="cmd-nice $1"
        shift
        set -- "$firstarg" "$@"
    fi

    if test "$penl_strip_pf" = "y"; then
        eval "$@" | sed 's/^pf-//'
    else
        eval "$@"
    fi
}

if test "$fuzzy" = "y"; then
    pen_eval "$shcode" | fzf
else
    pen_eval "$shcode"
fi
