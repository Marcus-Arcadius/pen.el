#!/bin/bash

# If mac
# --env="DISPLAY=host.docker.internal:0"

# echo "shutdown computer" | penf -u pf-nlsh/2 "Windows 95" {}

test_deps() {
    (
    set -xv
    command -v realpath && \
        command -v basename
    ) 2>&1
}

ensure_dependencies() {
    ds="$(test_deps)"
    code="$?"
    if ! test "$code" = 0; then
        echo "Please ensure dependencies are installed"

        for s in realpath basename; do
            echo "https://command-not-found.com/$s"
        done

        exit "$?"
    fi
}

ensure_dependencies

yn () {
    y_chars="Yy"
    n_chars="Nn"
    while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
        -N|-carefully) {
            allowed_re="^[YN]$"
            shift
        }
        ;;

        -y|-y-chars) {
            y_chars="$2"
            shift
            shift
        }
        ;;

        -n|-n-chars) {
            n_chars="$2"
            shift
            shift
        }
        ;;

        *) break;
    esac; done

    allowed_re="^[${y_chars}/${n_chars}]$"

    message="$@"

    : ${message:="Are you sure?"}

    exec 1>&2

    echo
    message="$(printf -- "%s" "$message")"
    echo -e " $message"
    echo

    allowed_re="$(printf -- "%s" "$allowed_re")"
    allowed_re_color="$(printf -- "%s" "$allowed_re")"

    if test "$YN_DEFAULT" = "y"; then
        echo y
        exit 0
    fi

    if test "$YN_DEFAULT" = "n"; then
        echo n
        exit 1
    fi

    while :; do
        read -p " $allowed_re_color: " -n 1 -r
        echo
        [[ $REPLY =~ $allowed_re ]] && break
    done
    echo

    [[ $REPLY =~ ^[$y_chars]$ ]]
}

{
stty stop undef; stty start undef
} 2>/dev/null

# TODO Add ability to share a file or entire directory with the host -- this would only work for docker run though
# But file sharing could work with the client if I use a hardlink to the ~/.pen/documents directory
# docker run --rm -v "$(pwd):/$(pwd | slugify)" -w "/$(pwd | slugify)" -ti --entrypoint= semiosis/pen.el:latest ./run.sh

IFS= read -r -d '' info_txt <<HEREDOC
Pen is under continual development.
If something is broken, try pulling everything.
If it's still broken, try again in a day.
If it's still broken, please make an issue on GitHub.
Or report to mullikine on Discord: https://discord.gg/JwKGbAdNHR
https://github.com/semiosis/pen.el/
HEREDOC

is_tty() { [ -t 1 ]; }

if is_tty; then
    HAS_TTY=y
else
    HAS_TTY=n
    batch=y
fi

sn="$(basename "$0")"
bn="$sn"
rp="$(realpath "$0")"

PEN_USE_GUI=y
share_x=y

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    "") { shift; }; ;;
    sh) {
        start_shell=y
        shift
    }
    ;;

    -tty|-nw) {
        use_tty=y
        shift
    }
    ;;

    -all|-a) {
        all=y
        shift
    }
    ;;

    # Show prompt
    -prompt|-p) {
        prompt=y
        shift
    }
    ;;

    -inject|-i) {
        inject_gen_start="$2"
        shift
        shift
    }
    ;;

    # No generation/query
    -nogen|-n) {
        no_gen=y
        shift
    }
    ;;

    -gui) {
        PEN_USE_GUI=y
        share_x=y
        shift
    }
    ;;

    -X) {
        share_x=y
        shift
    }
    ;;

    -nogui|-noX|-safe) {
        PEN_USE_GUI=n
        share_x=n
        shift
    }
    ;;

    -d) {
        DEBUG=y
        shift
    }
    ;;

    -u) {
        UPDATE=y
        shift
    }
    ;;

    -Q) {
        vanilla=y
        use_pen_config=n
        shift
    }
    ;;

    -q) {
        vanilla=y
        use_pen_config=y
        shift
    }
    ;;

    *) break;
esac; done

if ! test "$share_x" = "y"; then
    export DISPLAY=
fi

if test "$start_shell" = "y"; then
    export DISPLAY=
    # nvt

    docker exec -it pen 'sh' '-c' '. /root/.emacs.d/pen.el/scripts/setup-term.sh; /bin/bash || /bin/zsh || sh'
    exit "$?"
fi

cmd() {
    for var in "$@"
    do
        printf "'%s' " "$(printf %s "$var" | sed "s/'/'\\\\''/g")";
    done | sed 's/ $//'
}

cmd-nice() {
    # TODO Check for builtin
    # cmd-nice-jq

    for var in "$@"
    do
        printf '"%s" ' "$(printf %s "$var" | sed 's/\(\\*\)"/\1\1\\"/g')";
    done | sed 's/ $//'
}

vanilla=
use_pen_config=y

if test -d "$PEN_CONFIG_DIR"; then
    mkdir -p "$PEN_CONFIG_DIR/documents"
fi

if test "$use_pen_config" = "y"; then
    if ! test "$batch" = "y"; then
        if ! test -d "$HOME/.pen" && yn "Create ~/.pen on host (store API keys and generations)?"; then
            mkdir -p "$HOME/.pen"
        fi
    fi

    test -d "$HOME/.pen" && : "${PEN_CONFIG_DIR:="$HOME/.pen"}"

    if ! test "$batch" = "y"; then
        : "${PEN_CONFIG_DIR:="$(read -ep "PEN_CONFIG_DIR (leave empty to use docker): ")"}"
    fi

    if test -d "$PEN_CONFIG_DIR"; then
        PEN_CONFIG_DIR="$(realpath "$PEN_CONFIG_DIR")"
    fi
fi

if test "$sn" = pen && \
    test "$#" -eq 1 && \
    test -n "$1" && \
    test -f "$1" && \
    test -d "$PEN_CONFIG_DIR/documents"; then

    rp="$(realpath "$1")"
    bn="$(basename "$rp")"
    ln -f "$rp" "$PEN_CONFIG_DIR/documents/$bn"
    shift

    sn=penc

    # set -- -e "(find-file $(cmd-nice "/root/.pen/documents/$bn")"

    set -- "/root/.pen/documents/$bn"
fi

if test "$sn" = pen && test "$1" = -e; then
    shift
    sn=pene
fi

if test "$sn" = pen && test "$#" -eq 0 && test -n "$(docker ps --filter "name=pen" | sed 1d)"; then
    sn=penc
fi

stdin_exists() {
    ! [ -t 0 ] && ! test "$(readlink /proc/$$/fd/0)" = /dev/null
}

if test "$sn" = pena; then
    sn=penf
    all=y
fi

case "$sn" in
    penf) {
        if ! stdin_exists; then
            if test "$#" -eq 0; then
                sn=penl
                penl_strip_pf=y
            elif test "$#" -ge 1 && ! printf -- "%s\n" "$1" | grep -Pq "/$(( $# - 1 ))\$"; then
                sn=penh
                penl_strip_pf=y
            fi
        fi
    }
    ;;

    *)
esac

case "$sn" in
    pen|penf) {
        if test "$sn" = penf; then
            if test -n "$1" && ! printf -- "%s\n" "$1" | grep -q -P '^pf-'; then
                fun="pf-$1"
                shift
            else
                fun="$1"
                shift
            fi
            sn="pen"
        else
            fun="$1"
            shift
        fi

        if printf -- "%s\n" "$fun" | grep -q -P '^pf-'; then
            show_banner=n

            pfname="$fun"

            use_tty=y

            if stdin_exists; then
                in="$(cat | qne)"

                if test "$1" = {}; then
                    shift

                    # This has issues
                    set -- "$in" "$@"
                elif test "$#" -gt 1; then
                    i=1
                    found=
                    for var in "$@"
                    do
                        h="$((i - 1))"
                        j="$((i + 2))"
                        if test "$var" = "{}"; then
                            set -- "${@:1:$h}" "$in" "${@:j}"
                            found=y
                        fi
                        ((i++))
                    done
                    if ! test "$found" = "y"; then
                        # set -- "$@" "$in"
                        set -- "$in" "$@"
                    fi
                else
                    set -- "$in" "$@"
                fi
            fi

            if ! printf -- "%s\n" "$pfname" | grep -q -P '/[0-9]*'; then
                pfname="$pfname/$#"
            else
                # If the arity is specified, then take any extras and use as the variadic_arg

                arity="$(printf -- "%s" "$pfname" | cut -d / -f 2)"
                transultimate_pos="$((arity + 1))"

                variadic_arg_arr=("${@:transultimate_pos}")
                variadic_arg="$(cmd-nice "${variadic_arg_arr[@]}")"

                # Only keep the regular vars
                set -- "${@:1:$arity}"
            fi

            if test -n "$variadic_arg"; then
                variadic_arg="'($variadic_arg)"
            else
                variadic_arg=nil
            fi

            CMD="$(cmd-nice "$@")"

            if test "$prompt" = "y"; then
                include_prompt=t
            else
                include_prompt=nil
            fi

            if test "$nogen" = "y"; then
                no_gen=t
            else
                no_gen=nil
            fi

            if test -n "$inject_gen_start"; then
                inject_gen_start="$(cmd-nice "$inject_gen_start")"
            else
                inject_gen_start="nil"
            fi

            # if test "$DEBUG" = "y"; then
            #     echo "(json-encode-list (pen-batch (pen-update ($pfname $CMD :no-select-result t :include-prompt $include_prompt :no-gen $no_gen :variadic-var $variadic_arg))))" | tv &>/dev/null
            # fi

            if test "$all" = "y"; then
                if test "$UPDATE" = y; then
                    set -- -e "(json-encode-list (pen-batch (pen-update ($pfname $CMD :no-select-result t :include-prompt $include_prompt :no-gen $no_gen :variadic-var $variadic_arg :inject-gen-start $inject_gen_start))))"
                else
                    set -- -e "(json-encode-list (pen-batch ($pfname $CMD :no-select-result t :include-prompt $include_prompt :no-gen $no_gen :variadic-var $variadic_arg :inject-gen-start $inject_gen_start)))"
                fi
            else
                if test "$UPDATE" = y; then
                    set -- -e "(pen-list2str (pen-batch (pen-single-generation (pen-update ($pfname $CMD :no-select-result t :include-prompt $include_prompt :no-gen $no_gen :variadic-var $variadic_arg :inject-gen-start $inject_gen_start)))))"
                else
                    set -- -e "(pen-list2str (pen-batch (pen-single-generation ($pfname $CMD :no-select-result t :include-prompt $include_prompt :no-gen $no_gen :variadic-var $variadic_arg :inject-gen-start $inject_gen_start))))"
                fi
            fi

            HAS_TTY=n
            batch=y
            docker_cmd=exec
            remote_cmd=./.emacs.d/pen.el/scripts/eval.sh
        fi
    }
    ;;

    pensh) {
        # HAS_TTY=y
        batch=y
        use_tty=y
        docker_cmd=exec

        firstarg="$1"
        shift

        remote_cmd="$firstarg"
    }
    ;;

    penc) {
        set -- -c "$@"
    }
    ;;

    penw) {
        if test -d "$HOME/butterfly"; then
            cd "$HOME/butterfly"
            butterfly.server.py --host=localhost --port=57575 --unsecure --shell=pen
        else
            echo Could not find butterfly
        fi
        exit "$?"
    }
    ;;

    pene) {
        show_banner=n
        set -- -e "$@"
    }
    ;;

    penu) {
        show_banner=n
        UPDATE=y
        set -- -e "$@"
    }
    ;;

    penl) {
        show_banner=n
        set -- -e '(pen-list2str pen-prompt-functions)'
    }
    ;;

    lg) {
        show_banner=n
        set -- -ic "(funcall-interactively 'eww $(cmd-nice "$1"))"
    }
    ;;

    penh) {
        if test -n "$1" && ! printf -- "%s\n" "$1" | grep -q -P '^pf-'; then
            fun="$1"
            shift

            set -- "pf-$fun" "$@"
        fi

        if test -n "$1" && ! printf -- "%s\n" "$1" | grep -q -P '/[0-9]'; then
            if test "$#" -gt 0; then
                fun="$(penl | grep "^$1/" | head -n 1)"
            else
                fun="$(penl | grep "^$1/$#" | head -n 1)"
            fi
        fi

        show_banner=n
        if test "$#" -eq 0; then
            fun="$(penz)"
        else
            fun="$1"
        fi
        set -- -e "(helpful--signature '$fun)"
    }
    ;;

    penq) {
        show_banner=n
        set -- -e "(kill-emacs)"
    }
    ;;

    penz) {
        show_banner=n
        fuzzy=y
        set -- -e '(pen-list2str pen-prompt-functions)'
    }
    ;;

    *) {
        show_banner=n
        if stdin_exists; then
            in="$(cat)"

            if test "$1" = {}; then
                shift

                set -- "$(cat)" "$@"
            elif test "$#" -gt 1; then
                i=1
                for var in "$@"
                do
                    h="$((i - 1))"
                    j="$((i + 2))"
                    if test "$var" = "{}"; then
                        set -- "${@:1:$h}" "$in" "${@:j}"
                    fi
                    ((i++))
                done
            else
                set -- "$in" "$@"
            fi
        fi

        CMD="$(cmd-nice "$@")"
        set -- -e "(pen-list2str (pen-single-generation ($sn $CMD :no-select-result t)))"
        HAS_TTY=n
        batch=y
        docker_cmd=exec
        remote_cmd=./.emacs.d/pen.el/scripts/eval.sh
    }
    ;;
esac

{
if ! test "$show_banner" = n; then
    printf -- "%s\n" "$banner"
    pen-banner.sh
    echo
    echo Version: 0.1, License: GPL-3
    echo
    printf -- "%s\n" "$info_txt"
    echo
    looking-glass-logo.sh
    echo
fi
} 1>&2

: "${docker_cmd:="run"}"
: "${remote_cmd:="./run.sh"}"

opt="$1"
case "$opt" in
    uninstall) {
        set -xv
        sudo rm -irf ~/.pen
    }
    ;;

    *)
esac

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    "") { shift; }; ;;
    -c) {
        batch=y
        docker_cmd=exec

        shift

        CMD="$(cmd-nice "$@")"
        : ${CMD:="$(cmd-nice "$@")"}

        remote_cmd="./.emacs.d/pen.el/scripts/newframe.sh"

        # Shift all so it doesn't do -e here
        # shift "$#"
    }
    ;;

    -ic) {
        batch=y
        docker_cmd=exec
        interactive=y

        shift

        CMD="$(cmd-nice "$@")"
        : ${CMD:="$(cmd-nice "$@")"}

        remote_cmd="./.emacs.d/pen.el/scripts/newframe.sh"

        # Shift all so it doesn't do -e here
        # shift "$#"
    }
    ;;

    -e) {
        HAS_TTY=n
        batch=y
        docker_cmd=exec
        remote_cmd=./.emacs.d/pen.el/scripts/eval.sh
        shift

        if test "$UPDATE" = "y"; then
            last_arg="${@: -1}"
            test "$#" -gt 0 && set -- "${@:1:$(($#-1))}" # shift last arg

            set -- "$@" "(pen-update $last_arg)"
        fi
    }
    ;;

    *) break;
esac; done

if ! test "$vanilla" = "y"; then
    test -n "$MYGIT" && test -d "$MYGIT/semiosis/glossaries" && : "${GLOSSARIES_DIR:="$MYGIT/semiosis/glossaries"}"
    test -d "glossaries" && : "${GLOSSARIES_DIR:="glossaries"}"

    test -n "$MYGIT" && test -d "$MYGIT/semiosis/prompts" && : "${PROMPTS_DIR:="$MYGIT/semiosis/prompts"}"
    test -d "prompts" && : "${PROMPTS_DIR:="prompts"}"

    test -n "$MYGIT" && test -d "$MYGIT/semiosis/engines" && : "${ENGINES_DIR:="$MYGIT/semiosis/engines"}"
    test -d "engines" && : "${ENGINES_DIR:="engines"}"

    test -n "$MYGIT" && test -d "$MYGIT/semiosis/pen.el" && : "${PENEL_DIR:="$MYGIT/semiosis/pen.el"}"
    test -d "pen.el" && : "${PENEL_DIR:="pen.el"}"
    # : "${PENEL_DIR:="$(read -ep "PENEL_DIR (leave empty to use docker): ")"}"

    test -d "$MYGIT/semiosis/openai-api.el" && : "${OPENAI_API_EL_DIR:="$MYGIT/semiosis/openai-api.el"}"
    test -d "openai-api.el" && : "${OPENAI_API_EL_DIR:="openai-api.el"}"
    # : "${OPENAI_API_EL_DIR:="$(read -ep "OPENAI_API_EL_DIR (leave empty to use docker): ")"}"

    # yn "Pull docker image?" && docker pull semiosis/pen.el:latest

    # set -v
    if ! test "$batch" = "y"; then
        yn "Pull docker image?" && (
            echo docker pull semiosis/pen.el:latest
            docker pull semiosis/pen.el:latest
        )
    fi

    if ! test "$batch" = "y"; then
        if test -d "$ENGINES_DIR"; then
            yn "Pull engines repo? (recommended)" && (
                cd "$ENGINES_DIR"
                git pull origin master
            )
        else
            yn "Clone engines repo here?" && (
                git clone "http://github.com/semiosis/engines"
            )
        fi
    fi

    test -d "engines" && : "${ENGINES_DIR:="engines"}"

    if ! test "$batch" = "y"; then
        if test -d "$PROMPTS_DIR"; then
            yn "Pull prompts repo? (recommended)" && (
                cd "$PROMPTS_DIR"
                git pull origin master
            )
        else
            yn "Clone prompts repo here?" && (
                git clone "http://github.com/semiosis/prompts"
            )
        fi
    fi

    test -d "prompts" && : "${PROMPTS_DIR:="prompts"}"

    if ! test "$batch" = "y"; then
        test -d "$PENEL_DIR" && yn "Pull pen.el repo? (recommended)" && (
            cd "$PENEL_DIR"
            git pull origin master
        )
    fi

    if test -d "$PROMPTS_DIR"; then
        PROMPTS_DIR="$(realpath "$PROMPTS_DIR")"
    fi

    if test -d "$ENGINES_DIR"; then
        ENGINES_DIR="$(realpath "$ENGINES_DIR")"
    fi
fi

# TODO Solve permissions issues with the host ~/.pen directory

# --env "USER=$USER" \
# --env "GROUP=$USER" \
# --env "USER_ID=1000" \
# --env "GROUP_ID=1000" \

if ! test -n "$DISPLAY"; then
    PEN_USE_GUI=n
fi

export PEN_USE_GUI

case "$docker_cmd" in
    run) {

    if test -n "$DISPLAY"; then
        cmd-nice xhost + | awk 1 1>&2
        xhost +

        echo
        echo If this fails, try running pen with -noX
        echo " pen -noX"
        echo
    fi

IFS= read -r -d '' shcode <<HEREDOC
    # --user "$(id -u):$(id -g)"
    docker "$docker_cmd" \
        $(test -n "$OPENAI_API_KEY" && printf -- "%s " -e "OPENAI_API_KEY:$OPENAI_API_KEY" ) \
        $(test -n "$PEN_CONFIG_DIR" && printf -- "%s " -v "$PEN_CONFIG_DIR:/root/.pen" ) \
        $(test -n "$PROMPTS_DIR" && printf -- "%s " -v "$PROMPTS_DIR:/root/.emacs.d/host/prompts" ) \
        $(test -n "$ENGINES_DIR" && printf -- "%s " -v "$ENGINES_DIR:/root/.emacs.d/host/engines" ) \
        $(test -n "$PENEL_DIR" && printf -- "%s " -v "$PENEL_DIR:/root/.emacs.d/host/pen.el" ) \
        $(test -n "$GLOSSARIES_DIR" && printf -- "%s " -v "$GLOSSARIES_DIR:/root/.emacs.d/host/glossaries" ) \
        $(test -n "$OPENAI_API_EL_DIR" && printf -- "%s " -v "$OPENAI_API_EL_DIR:/root/.emacs.d/host/openai-api.el" ) \
        $(test "$HAS_TTY" = y && printf -- "%s " -ti ) \
        --env TERM \
        $(if test -n "$DISPLAY"; then
        cmd --privileged \
        --env COLORFGBG \
        -e DISPLAY=${DISPLAY} \
        --env EMAIL \
        --env PEN_USE_GUI \
        --env GIT_AUTHOR_EMAIL \
        --env GIT_AUTHOR_NAME \
        --env GIT_COMMITTER_EMAIL \
        --env GIT_COMMITTER_NAME \
        --env SSH_AUTH_SOCK \
        --env "TIMEZONE=UTC" \
        --env "VIDEO_GROUP_ID=44" \
        -v /dev/dri:/dev/dri \
        -v /dev/shm:/dev/shm \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        "--cap-add=SYS_PTRACE" \
        "--cap-add=SYS_ADMIN" \
        "--cap-add=NET_ADMIN" \
        --ulimit "rtprio=100:100" \
        --network host \
        -v /var/log/coredumps:/var/log/coredumps
            else
                cmd --network host
        fi
        ) \
        --expose 57575 -p 57575:57575 \
        --entrypoint= --name=pen semiosis/pen.el:latest "$remote_cmd"
HEREDOC
    }
    ;;

    # --user "$(id -u):$(id -g)"
    exec) {
        if test "$interactive" = "y"; then
            set -- -e "$@"
        fi

        evalcommand="$(cmd-nice "$(cmd-nice eval "$(cmd-nice "$remote_cmd" "$@")")")"
IFS= read -r -d '' shcode <<HEREDOC
docker "$docker_cmd" $(test "$HAS_TTY" = y && printf -- "%s " -ti ) pen bash -c $evalcommand
HEREDOC
    }
    ;;

    *)
esac

pen_eval() {
    if test "$DEBUG" = "y"; then
        firstarg="cmd-nice $1"
        shift
        set -- "$firstarg" "$@"
    fi

    if test "$penl_strip_pf" = "y"; then
        eval "$@" | sed 's/^pf-//'
    else
        eval "$@"
    fi
}

if test "$fuzzy" = "y"; then
    pen_eval "$shcode" | fzf
else
    pen_eval "$shcode"
fi
