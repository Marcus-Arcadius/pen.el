#!/bin/bash
export TTY

# ct vim /

: ${CWD:="$(pwd)"}

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    -E) {
        DO_EXEC=y
        shift
    }
    ;;

    -nv) {
        export USE_NVC=y
        shift
    }
    ;;

    *) break;
esac; done

if test "$DO_EXEC" = "y"; then
    CMD="$1"
else
    CMD="$(cmd-nice-posix "$@")"
fi

inside-docker-p() {
    test -f /.dockerenv
}

if inside-docker-p; then
    cterm-docker "$@"
else
    # This runs in the docker to the host
    cterm-docker ssh \
        -i "~/.pen/host_key" \
        -o ControlMaster=auto \
        -o ControlPath="~/ssh-controlpath-%r@%h:%p" \
        -o UserKnownHostsFile=/dev/null \
        -o StrictHostKeyChecking=no \
        -t $USER@$(hostname) \
        "bash -l -c $(cmd-nice-posix ". ~/.profile; cd $(cmd-nice-posix "$CWD"); $CMD")"
fi
