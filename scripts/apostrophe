#!/bin/bash
export TTY

# Apostrophe
# Version 1.0, bash

# Apostrophe is a figure of speech in which a speaker directly addresses someone
# (or something) that is not present or cannot respond in reality. ... An
# apostrophe is often introduced by the exclamation "O," as when Juliet cries
# out: "O Romeo, Romeo, Wherefore art thou Romeo?"

FRAMETYPE=tty

while [ $# -gt 0 ]; do opt="$1"; case "$opt" in
    "") { shift; }; ;;
    -nv) {
        USE_NVC=y
        shift
    }
    ;;

    -tty|-nw|-t) {
        export PEN_USE_GUI=n
        FRAMETYPE=tty
        shift
    }
    ;;

    -gui) {
        export PEN_USE_GUI=y
        FRAMETYPE=gui
        shift
    }
    ;;

    *) break;
esac; done

export USE_NVC

stdin_exists() {
    ! [ -t 0 ] && ! test "$(readlink /proc/$$/fd/0)" = /dev/null
}

# test -n "$person" || {
#     echo "Person name required as parameter." 12
#     exit 1
# }

person="$@"

# PEN_USE_GUI is unset by design apparently

if stdin_exists; then
    text="$(cat)"
    pen -frametype "$FRAMETYPE" --pool -ic "(progn (apostrophe-start-chatbot-from-selection $(cmd-nice-posix "$text"))(delete-other-windows))"
elif test -n "$person"; then
    exec <&1
    pen -frametype "$FRAMETYPE" --pool -ic "(progn (upd (apostrophe-start-chatbot-from-name $(cmd-nice-posix "$person") t))(delete-other-windows))"
else
    pen -frametype "$FRAMETYPE" --pool -ic "(progn (call-interactively 'apostrophe-start-chatbot-from-name)(delete-other-windows))"
fi
